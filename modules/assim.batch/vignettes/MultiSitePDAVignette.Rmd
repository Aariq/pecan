---
title: "HB-PDA vignette"
author: "Istem Fer"
date: "3/2/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Multi-Site Hierarchical PDA

This vignette documents the steps and settings of Hierarchical Bayesian Parameter Data Assimilation (HB-PDA) analysis on multiple sites. If you haven't done the standard PDA check that vignette first modules/assim.batch/vignettes/AssimBatchVignette.Rmd

## Start with multi-settings

Add the `<sitegroup>` tag in your `pecan.xml` for the groups of sites you are interested in. In this vignette, we will use HB-PDA site group in BETYdb which consists of the temperate decidious broadleaf forest (DBF) sites of Ameriflux network.


```
<sitegroup>
   <id>1000000022</id>
</sitegroup>
```
In the meantime, your `<run>` tag will look like this:
```
  <run>
    <inputs>
      <met>
        <source>AmerifluxLBL</source>
        <output>SIPNET</output>
      <username>pecan</username>
      </met>
    </inputs>
    <start.date>2004/01/01</start.date>
    <end.date>2004/12/31</end.date>
  </run>
```

It's OK if not all your sites have the same `start.date` and `end.date`, multi settings functions will use this as a template to expand.

Now start going through the workflow script and stop after:
```
# Write pecan.CHECKED.xml
PEcAn.settings::write.settings(settings, outputfile = "pecan.CHECKED.xml")
```

When you open `pecan.CHECKED.xml`, you'll see that  the `<run>` tag has expanded with the same information repeated. Now you specify `<inputs>`, `<start.date>` and `<end.date>` information accordingly if you want them to be different. E.g.:

```
 <run>
  <settings.1>
   <site>
    <id>796</id>
    <met.start>2005/01/01</met.start>
    <met.end>2011/12/31</met.end>
    <name>Bartlett Experimental Forest (US-Bar)</name>
    <lat>44.06464</lat>
    <lon>-71.288077</lon>
   </site>
   <start.date>2005/01/01</start.date>
   <end.date>2011/12/31</end.date>
   <inputs>
    <met>
     <path>/fs/data1/pecan.data/dbfiles/AmerifluxLBL_SIPNET_site_0-796/AMF_US-Bar_BASE_HH_4-1.2005-01-01.2011-12-31.clim</path>
    </met>
   </inputs>
  </settings.1>
  <settings.2>
   <site>
    <id>767</id>
    <met.start>2001/01/01</met.start>
    <met.end>2014/12/31</met.end>
    <name>Morgan Monroe State Forest (US-MMS)</name>
    <lat>39.3231</lat>
    <lon>-86.4131</lon>
   </site>
   <start.date>2001/01/01</start.date>
   <end.date>2014/12/31</end.date>
   <inputs>
    <met>
     <path>/fs/data1/pecan.data/dbfiles/AmerifluxLBL_SIPNET_site_0-767/AMF_US-MMS_BASE_HR_8-1.2001-01-01.2014-12-31.clim</path>
    </met>
   </inputs>
  </settings.2>
  <settings.3>
   <site>
    <id>768</id>
    <met.start>2005/01/01</met.start>
    <met.end>2015/12/31</met.end>
    <name>Missouri Ozark Site/BREA (US-MOz)</name>
    <lat>38.7441</lat>
    <lon>-92.2</lon>
   </site>
   <start.date>2005/01/01</start.date>
   <end.date>2015/12/31</end.date>
   <inputs>
    <met>
     <path>/fs/data1/pecan.data/dbfiles/AmerifluxLBL_SIPNET_site_0-768/AMF_US-MOz_BASE_HH_7-1.2005-01-01.2015-12-31.clim</path>
    </met>
   </inputs>
  </settings.3>
  <settings.4>
   <site>
    <id>776</id>
    <met.start>2007/01/01</met.start>
    <met.end>2014/12/31</met.end>
    <name>Univiversity of Michigan Biological Station (US-UMB)</name>
    <lat>45.5598</lat>
    <lon>-84.7138</lon>
   </site>
   <start.date>2007/01/01</start.date>
   <end.date>2014/12/31</end.date>
   <inputs>
    <met>
     <path>/fs/data1/pecan.data/dbfiles/AmerifluxLBL_SIPNET_site_0-776/AMF_US-UMB_BASE_HH_10-1.2007-01-01.2014-12-31.clim</path>
    </met>
   </inputs>
  </settings.4>
  <settings.5>
   <site>
    <id>676</id>
    <met.start>1999/01/01</met.start>
    <met.end>2006/12/31</met.end>
    <name>Willow Creek (US-WCr)</name>
    <lat>45.805925</lat>
    <lon>-90.07961</lon>
   </site>
   <start.date>1999/01/01</start.date>
   <end.date>2006/12/31</end.date>
   <inputs>
    <met>
     <path>/fs/data1/pecan.data/dbfiles/AmerifluxLBL_SIPNET_site_0-676/AMF_US-WCr_BASE_HH_11-1.1999-01-01.2006-12-31.clim</path>
    </met>
   </inputs>
  </settings.5>
  <settings.6>
   <site>
    <id>1000000109</id>
    <met.start>2013/01/01</met.start>
    <met.end>2015/12/31</met.end>
    <name>Ontario - Turkey Point Mature Deciduous (CA-TPD)</name>
    <lat>42.6353</lat>
    <lon>-80.5577</lon>
   </site>
   <start.date>2013/01/01</start.date>
   <end.date>2015/12/31</end.date>
   <inputs>
    <met>
     <path>/fs/data1/pecan.data/dbfiles/AmerifluxLBL_SIPNET_site_1-109/AMF_CA-TPD_BASE_HH_1-1.2013-01-01.2015-12-31.clim</path>
    </met>
   </inputs>
  </settings.6>
  <settings.7>
   <site>
    <id>755</id>
    <met.start>2002/01/01</met.start>
    <met.end>2008/12/31</met.end>
    <name>Duke Forest-hardwoods (US-Dk2)</name>
    <lat>35.9736</lat>
    <lon>-79.1004</lon>
   </site>
   <start.date>2002/01/01</start.date>
   <end.date>2008/12/31</end.date>
   <inputs>
    <met>
     <path>/fs/data1/pecan.data/dbfiles/AmerifluxLBL_SIPNET_site_0-755/AMF_US-Dk2_BASE_HH_4-4.2002-01-01.2008-12-31.clim</path>
    </met>
   </inputs>
  </settings.7>
  <settings.8>
   <site>
    <id>1000000145</id>
    <met.start>2008/01/01</met.start>
    <met.end>2010/12/31</met.end>
    <name>Chestnut Ridge (US-ChR)</name>
    <lat>35.9311</lat>
    <lon>-84.3324</lon>
   </site>
   <start.date>2008/01/01</start.date>
   <end.date>2010/12/31</end.date>
   <inputs>
    <met>
     <path>/fs/data1/pecan.data/dbfiles/AmerifluxLBL_SIPNET_site_1-145/AMF_US-ChR_BASE_HH_2-1.2008-01-01.2010-12-31.clim</path>
    </met>
   </inputs>
  </settings.8>
  <settings.9>
   <site>
    <id>1000000066</id>
    <met.start>2005/01/01</met.start>
    <met.end>2014/12/31</met.end>
    <name>Silas Little- New Jersey (US-Slt)</name>
    <lat>39.9138</lat>
    <lon>-74.596</lon>
   </site>
   <start.date>2005/01/01</start.date>
   <end.date>2014/12/31</end.date>
   <inputs>
    <met>
     <path>/fs/data1/pecan.data/dbfiles/AmerifluxLBL_SIPNET_site_1-66/AMF_US-Slt_BASE_HH_5-1.2005-01-01.2014-12-31.clim</path>
    </met>
   </inputs>
  </settings.9>
  <settings.10>
   <site>
    <id>1000000061</id>
    <met.start>2004/01/01</met.start>
    <met.end>2013/12/31</met.end>
    <name>Oak Openings (US-Oho)</name>
    <lat>41.5545</lat>
    <lon>-83.8438</lon>
   </site>
   <start.date>2004/01/01</start.date>
   <end.date>2013/12/31</end.date>
   <inputs>
    <met>
     <path>/fs/data1/pecan.data/dbfiles/AmerifluxLBL_SIPNET_site_1-61/AMF_US-Oho_BASE_HH_4-1.2004-01-01.2013-12-31.clim</path>
    </met>
   </inputs>
  </settings.10>
  <settings.11>
   <site>
    <id>740</id>
    <met.start>1997/01/01</met.start>
    <met.end>2010/12/31</met.end>
    <name>BOREAS SSA Old Aspen (CA-Oas)</name>
    <lat>53.6289</lat>
    <lon>-106.198</lon>
   </site>
   <start.date>1997/01/01</start.date>
   <end.date>2010/12/31</end.date>
   <inputs>
    <met>
     <path>/fs/data1/pecan.data/dbfiles/AmerifluxLBL_SIPNET_site_0-740/AMF_CA-Oas_BASE_HH_1-1.1997-01-01.2010-12-31.clim</path>
    </met>
   </inputs>
  </settings.11>
  <settings.12>
   <site>
    <id>758</id>
    <met.start>2010/01/01</met.start>
    <met.end>2015/12/31</met.end>
    <name>Harvard Forest EMS Tower/HFR1 (US-Ha1)</name>
    <lat>42.5378</lat>
    <lon>-72.1715</lon>
   </site>
   <start.date>2010/01/01</start.date>
   <end.date>2015/12/31</end.date>
   <inputs>
    <met>
     <path>/fs/data1/pecan.data/dbfiles/AmerifluxLBL_SIPNET_site_0-758/AMF_US-Ha1_BASE_HR_10-1.2010-01-01.2015-12-31.clim</path>
    </met>
   </inputs>
  </settings.12>
 </run>
```

Re-read the updated `pecan.CHECKED.xml`, make sure to re-assign random effects as logical, otherwise `meta.analysis` will throw an error:
```
settings <- read.settings("pecan.CHECKED.xml")
settings$meta.analysis$random.effects <- as.logical(settings$meta.analysis$random.effects)
```

Then continue with the rest of the workflow until `<assim.batch>` module:
```
# Run parameter data assimilation
if ('assim.batch' %in% names(settings)) {
  if (PEcAn.utils::status.check("PDA") == 0) {
    PEcAn.utils::status.start("PDA")
    settings <- PEcAn.assim.batch::runModule.assim.batch(settings)
    PEcAn.utils::status.end()
  }
}
```

Now add the PDA tags, see next section.


## Settings for HB-PDA

Similar to PDA settings, we will contain HB-PDA settings under the `<assim.batch>` section. Likewise standard PDA, if you have chosen the parameters you want to target in the calibration, we will open the `pecan.CONFIGS.xml` file, and insert the `<assim.batch>` tag. 

Different from the PDA settings, this time the main function will be the `emulator.ms`. This function can be run in three modes, which will be selected under the `<mode>` tag above: individual, joint and hierarchical. If left empty, the function will go through all three modes. But note that, for both joint and hierarhical calibration, we need site-level runs. We will start with individual mode, i.e. site-level calibration. 

Now open the `pecan.CONFIGS.xml` file. First, add `<assim.batch>` tag to the multisettings in the bottom of your xml among others: 

```
 <multisettings>
  <multisettings>assim.batch</multisettings>
  <multisettings>ensemble</multisettings>
  <multisettings>sensitivity.analysis</multisettings>
  <multisettings>run</multisettings>
 </multisettings>
```

Now we can insert multi-site settings in the `<assim.batch>` section accordingly (note that `method`, `mode`, `param.names` etc. will go under each `setting.*`):

```
 <assim.batch>
  <settings.1>
    <method>emulator.ms</method>
    <mode>individual</mode>
    <n.knot>70</n.knot>
    <iter>100000</iter>
    <chain>3</chain>
    <param.names>
     <soil.IF>
      <param>som_respiration_rate</param>
      <param>soil_respiration_Q10</param>
     </soil.IF>
     <temperate.deciduous.IF>
      <param>psnTOpt</param>
      <param>half_saturation_PAR</param>
      <param>dVPDSlope</param>
      <param>leafGrowth</param>
      <param>AmaxFrac</param>
     </temperate.deciduous.IF>
    </param.names>
    <inputs>
      <file>
        <input.id>1000013322</input.id>
        <path>
         <path>/fs/data1/pecan.data/dbfiles/AmerifluxLBL_site_0-796/AMF_US-Bar_BASE_HH_4-1.csv</path>
        </path>
        <likelihood>Laplace</likelihood>
        <variable.id>1000000042</variable.id>
        <variable.name>
          <variable.name>FC</variable.name>
          <variable.name>UST</variable.name>
       </variable.name>
     </file>
    </inputs>
  </settings.1>
  <settings.2>
    <method>emulator.ms</method>
    <mode>individual</mode>
    <n.knot>70</n.knot>
    <iter>100000</iter>
    <chain>3</chain>
    <param.names>
     <soil.IF>
      <param>som_respiration_rate</param>
      <param>soil_respiration_Q10</param>
     </soil.IF>
     <temperate.deciduous.IF>
      <param>psnTOpt</param>
      <param>half_saturation_PAR</param>
      <param>dVPDSlope</param>
      <param>leafGrowth</param>
      <param>AmaxFrac</param>
     </temperate.deciduous.IF>
    </param.names>
    <inputs>
      <file>
        <input.id>1000013317</input.id>
        <path>
         <path>/fs/data1/pecan.data/dbfiles/AmerifluxLBL_site_0-767/AMF_US-MMS_BASE_HR_8-1.csv</path>
        </path>
        <likelihood>Laplace</likelihood>
        <variable.id>1000000042</variable.id>
        <variable.name>
          <variable.name>FC</variable.name>
          <variable.name>UST</variable.name>
       </variable.name>
     </file>
    </inputs>
  </settings.2>
  <settings.3>
    <method>emulator.ms</method>
    <mode>individual</mode>
    <n.knot>70</n.knot>
    <iter>100000</iter>
    <chain>3</chain>
    <param.names>
     <soil.IF>
      <param>som_respiration_rate</param>
      <param>soil_respiration_Q10</param>
     </soil.IF>
     <temperate.deciduous.IF>
      <param>psnTOpt</param>
      <param>half_saturation_PAR</param>
      <param>dVPDSlope</param>
      <param>leafGrowth</param>
      <param>AmaxFrac</param>
     </temperate.deciduous.IF>
    </param.names>
    <inputs>
      <file>
        <input.id>1000013316</input.id>
        <path>
         <path>/fs/data1/pecan.data/dbfiles/AmerifluxLBL_site_0-768/AMF_US-MOz_BASE_HH_7-1.csv</path>
        </path>
        <likelihood>Laplace</likelihood>
        <variable.id>1000000042</variable.id>
        <variable.name>
          <variable.name>FC</variable.name>
          <variable.name>UST</variable.name>
       </variable.name>
     </file>
    </inputs>
  </settings.3>
  <settings.4>
    <method>emulator.ms</method>
    <mode>individual</mode>
    <n.knot>70</n.knot>
    <iter>100000</iter>
    <chain>3</chain>
    <param.names>
     <soil.IF>
      <param>som_respiration_rate</param>
      <param>soil_respiration_Q10</param>
     </soil.IF>
     <temperate.deciduous.IF>
      <param>psnTOpt</param>
      <param>half_saturation_PAR</param>
      <param>dVPDSlope</param>
      <param>leafGrowth</param>
      <param>AmaxFrac</param>
     </temperate.deciduous.IF>
    </param.names>
    <inputs>
      <file>
        <input.id>1000013832</input.id>
        <path>
         <path>/fs/data1/pecan.data/dbfiles/AmerifluxLBL_site_0-776/AMF_US-UMB_BASE_HH_10-1.csv</path>
        </path>
        <likelihood>Laplace</likelihood>
        <variable.id>1000000042</variable.id>
        <variable.name>
          <variable.name>FC</variable.name>
          <variable.name>UST</variable.name>
       </variable.name>
     </file>
    </inputs>
  </settings.4>
  <settings.5>
    <method>emulator.ms</method>
    <mode>individual</mode>
    <n.knot>70</n.knot>
    <iter>100000</iter>
    <chain>3</chain>
    <param.names>
     <soil.IF>
      <param>som_respiration_rate</param>
      <param>soil_respiration_Q10</param>
     </soil.IF>
     <temperate.deciduous.IF>
      <param>psnTOpt</param>
      <param>half_saturation_PAR</param>
      <param>dVPDSlope</param>
      <param>leafGrowth</param>
      <param>AmaxFrac</param>
     </temperate.deciduous.IF>
    </param.names>
    <inputs>
      <file>
        <input.id>1000012965</input.id>
        <path>
         <path>/fs/data1/pecan.data/dbfiles/AmerifluxLBL_site_0-676/AMF_US-WCr_BASE_HH_11-1.csv</path>
        </path>
        <likelihood>Laplace</likelihood>
        <variable.id>1000000042</variable.id>
        <variable.name>
          <variable.name>FC</variable.name>
          <variable.name>UST</variable.name>
       </variable.name>
     </file>
    </inputs>
  </settings.5>
  <settings.6>
    <method>emulator.ms</method>
    <mode>individual</mode>
    <n.knot>70</n.knot>
    <iter>100000</iter>
    <chain>3</chain>
    <param.names>
     <soil.IF>
      <param>som_respiration_rate</param>
      <param>soil_respiration_Q10</param>
     </soil.IF>
     <temperate.deciduous.IF>
      <param>psnTOpt</param>
      <param>half_saturation_PAR</param>
      <param>dVPDSlope</param>
      <param>leafGrowth</param>
      <param>AmaxFrac</param>
     </temperate.deciduous.IF>
    </param.names>
    <inputs>
      <file>
        <input.id>1000013836</input.id>
        <path>
         <path>/fs/data1/pecan.data/dbfiles/AmerifluxLBL_site_1-109/AMF_CA-TPD_BASE_HH_1-1.csv</path>
        </path>
        <likelihood>Laplace</likelihood>
        <variable.id>1000000042</variable.id>
        <variable.name>
          <variable.name>FC</variable.name>
          <variable.name>UST</variable.name>
       </variable.name>
     </file>
    </inputs>
  </settings.6>
  <settings.7>
    <method>emulator.ms</method>
    <mode>individual</mode>
    <n.knot>70</n.knot>
    <iter>100000</iter>
    <chain>3</chain>
    <param.names>
     <soil.IF>
      <param>som_respiration_rate</param>
      <param>soil_respiration_Q10</param>
     </soil.IF>
     <temperate.deciduous.IF>
      <param>psnTOpt</param>
      <param>half_saturation_PAR</param>
      <param>dVPDSlope</param>
      <param>leafGrowth</param>
      <param>AmaxFrac</param>
     </temperate.deciduous.IF>
    </param.names>
    <inputs>
      <file>
        <input.id>1000013546</input.id>
        <path>
         <path>/fs/data1/pecan.data/dbfiles/AmerifluxLBL_site_1-145/AMF_US-ChR_BASE_HH_2-1.csv</path>
        </path>
        <likelihood>Laplace</likelihood>
        <variable.id>1000000042</variable.id>
        <variable.name>
          <variable.name>FC</variable.name>
          <variable.name>UST</variable.name>
       </variable.name>
     </file>
    </inputs>
  </settings.7>
  <settings.8>
    <method>emulator.ms</method>
    <mode>individual</mode>
    <n.knot>70</n.knot>
    <iter>100000</iter>
    <chain>3</chain>
    <param.names>
     <soil.IF>
      <param>som_respiration_rate</param>
      <param>soil_respiration_Q10</param>
     </soil.IF>
     <temperate.deciduous.IF>
      <param>psnTOpt</param>
      <param>half_saturation_PAR</param>
      <param>dVPDSlope</param>
      <param>leafGrowth</param>
      <param>AmaxFrac</param>
     </temperate.deciduous.IF>
    </param.names>
    <inputs>
      <file>
        <input.id>1000013572</input.id>
        <path>
         <path>/fs/data1/pecan.data/dbfiles/AmerifluxLBL_site_1-66/AMF_US-Slt_BASE_HH_5-1.csv</path>
        </path>
        <likelihood>Laplace</likelihood>
        <variable.id>1000000042</variable.id>
        <variable.name>
          <variable.name>FC</variable.name>
          <variable.name>UST</variable.name>
       </variable.name>
     </file>
    </inputs>
  </settings.8>
    <settings.9>
    <method>emulator.ms</method>
    <mode>individual</mode>
    <n.knot>70</n.knot>
    <iter>100000</iter>
    <chain>3</chain>
    <param.names>
     <soil.IF>
      <param>som_respiration_rate</param>
      <param>soil_respiration_Q10</param>
     </soil.IF>
     <temperate.deciduous.IF>
      <param>psnTOpt</param>
      <param>half_saturation_PAR</param>
      <param>dVPDSlope</param>
      <param>leafGrowth</param>
      <param>AmaxFrac</param>
     </temperate.deciduous.IF>
    </param.names>
    <inputs>
      <file>
        <input.id>1000013482</input.id>
        <path>
         <path>/fs/data1/pecan.data/dbfiles/AmerifluxLBL_site_1-61/AMF_US-Oho_BASE_HH_4-1.csv</path>
        </path>
        <likelihood>Laplace</likelihood>
        <variable.id>1000000042</variable.id>
        <variable.name>
          <variable.name>FC</variable.name>
          <variable.name>UST</variable.name>
       </variable.name>
     </file>
    </inputs>
  </settings.9>
  </assim.batch>
```

Now save this as `pecan.HBPDA.xml` and read it. 

Following section briefly explains what happens after:
```
multi.settings <- read.settings("pecan.HBPDA.xml")
pda.emulator.ms(multi.settings)
```

## The workflow for HB-PDA

HB-PDA workflow for multiple sites starts with fitting models locally. This is done by looping over the PEcAn multi-settings list using the `pda.emulator` function. During this step, site-level runs, GP fitting and MCMC are done. Components of these runs are saved and will be used in global and hierarhical fitting. 

In global calibration, we estimate posterior using all site-level GPs at once at each iteration. Proposed values are plugged-in all GPs, and accepted/rejected according to all estimated likelihoods.

Hierarhical calibration, uses a similar function to `mcmc.GP` but modified for hierarchihcal fitting, called `hier.mcmc`. Within this function, both site-level and (hierarchically modeled) global parameters are fitted.